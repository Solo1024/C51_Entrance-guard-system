C51 COMPILER V9.01   MAIN                                                                  07/28/2020 12:51:37 PAGE 1   


C51 COMPILER V9.01, COMPILATION OF MODULE MAIN
OBJECT MODULE PLACED IN main.obj
COMPILER INVOKED BY: D:\软件\Keil_4_c51单片机开发\C51\BIN\C51.EXE arc\main.c BROWSE INCDIR(.\arc) DEBUG OBJECTEXTEND PRI
                    -NT(.\main.lst) OBJECT(main.obj)

line level    source

   1          /*********************************************************************
   2                                  
   3          **********************************************************************
   4          实验序列：
   5          实验任务:       
   6          实现现象：
   7          硬件接线：
   8          注意事项：(1) 板载晶振为12MHz，波特率为2400、4800、7200均可找到误差不太
   9                                    大的设置值，而有些波特率如9600则无法找到误差小的设置值，
  10                                    因此不要设置9600这类波特率。
  11                            (2) 整个串口的代码和波特率计算，都可以由单片机小精灵工具自动
  12                                计算和生成，但是自己要理解计算过程，要能结合数据手册看懂
  13                                    代码是怎么回事，不能只知其然不知其所以然
  14                            (3) 注意上位机串口助手的设置参考本文件夹中图“8.1.串口助手设置.png”
  15                            (4) 因为上位机中串口不能被2个程序同时打开，因此在stcisp软件下载
  16                                程序前必须将串口助手中串口关闭，否则一旦串口助手中打开串口
  17                                    情况下进行下载，则stcisp软件会提示下载串口打开失败
  18                            
  19          版    本：
  20          作    者：陈步步
  21          时        间：                                                                            
  22          **********************************************************************/
  23          
  24          
  25          /*
  26          **********************************************************************
  27          *                         头文件包含
  28          **********************************************************************
  29          */
  30          #include <reg52.h>
  31          #include "main.h"
  32          #include "rc522.h"
  33          #include<string.h>
  34          
  35          sbit gBuzzer=P3^3;//无源蜂鸣器
  36          sbit PWM=P3^2;   //舵机
  37          
  38          /*
  39          **********************************************************************
  40          *                         本地全局变量
  41          **********************************************************************
  42          */
  43                  
  44          u8 UID[5],Temp[4];
  45          u16 count = 0, time=0;
  46          u8 UI[5]={0XCA,0xEF,0x7C,0x29 };           //E  此处为6张卡的信息
  47          u8 UI1[5]={0XCA,0X6F,0X3C,0X29}; //A
  48          u8 UI2[5]={0x51,0x7E,0xC9,0xCF}; //B              
  49          u8 UI3[5]={0x31,0x11,0x1B,0xD0}; //C
  50          u8 UI4[5]={0x8C,0xF3,0xDA,0x0B}; //D
  51          u8 UI5[5]={0x19,0x74,0xD9,0x59}; //E
  52          void Rc522Test1(void);
  53          void Rc522Test2(void);
  54          
C51 COMPILER V9.01   MAIN                                                                  07/28/2020 12:51:37 PAGE 2   

  55          
  56          /*********************************************************************
  57          * 函 数 名       : main
  58          * 函数功能               : 主函数
  59          * 参数列表       : 无
  60          * 函数输出       : 无
  61          *********************************************************************/
  62          void init0()
  63          {
  64   1              TMOD = 0x01;    // 方式一
  65   1              TH0 = 0X0FF;
  66   1              TL0 = 0XA3;
  67   1              TR0 = 1;       // 开启定时器0
  68   1              EA = 1;            // 开启总中断
  69   1              ET0 = 1;       // 定时器0允许中断
  70   1      }
  71          //舵机
  72          void T0_inter() interrupt 1
  73          {
  74   1              TR0 = 0;
  75   1              TH0 = 0XFF;
  76   1              TL0 = 0XA3;
  77   1              TR0 = 1;
  78   1              
  79   1      
  80   1              time ++ ;
  81   1              if (time < count)       
  82   1              {
  83   2                      PWM = 1;
  84   2              }
  85   1              else
  86   1              {
  87   2                      PWM = 0;
  88   2              }
  89   1              if (time >= 200)
  90   1              {
  91   2                      time = 0;
  92   2              }
  93   1      }
  94          void main(void)
  95          {
  96   1              gBuzzer=0;
  97   1          init0();
  98   1      
  99   1              
 100   1              SysInit();
 101   1              Rc522Test1(); //最终运行代码
 102   1      //      Rc522Test2(); //读取卡片数据，视情况test1和test2选一
 103   1              
 104   1      }
 105          
 106          
 107          /*********************************************************************
 108          * 函 数 名       : BuzzerOnce
 109          * 函数功能               : 蜂鸣器叫1下表示寻卡成功
 110          * 参数列表       : 无
 111          * 函数输出       : 无
 112          *********************************************************************/
 113          void BuzzerOnce(void)
 114          {
 115   1              u8 a,b,i;
 116   1              for(i=2;i>0;i--){
C51 COMPILER V9.01   MAIN                                                                  07/28/2020 12:51:37 PAGE 3   

 117   2                      for(b=50;b>0;b--){
 118   3                          for(a=2;a>0;a--){
 119   4                                              gBuzzer = 0;
 120   4                                              delay10us(10);
 121   4                                              gBuzzer = 1;
 122   4                                              delay10us(10);
 123   4                                      }
 124   3                 }
 125   2              }
 126   1      }
 127          
 128          /*********************************************************************
 129          * 函 数 名       : delay1ms
 130          * 函数功能               : 延时
 131          * 参数列表       : 无
 132          * 函数输出       : 无
 133          *********************************************************************/
 134          void delay1ms(unsigned int i)   //误差 0us,括号内填什么数字就是多少毫秒
 135          {
 136   1          unsigned char a,b,c;
 137   1              for(;i>0;i--)
 138   1                 for(c=1;c>0;c--)
 139   1                  for(b=142;b>0;b--)
 140   1                          for(a=2;a>0;a--);
 141   1      }
 142          
 143          
 144          /*********************************************************************
 145          * 函 数 名       : delay10us
 146          * 函数功能               : 延时
 147          * 参数列表       : 无
 148          * 函数输出       : 无
 149          *********************************************************************/
 150          void delay10us(unsigned char i)   //误差 0us,括号内填什么数字就是多少个十微秒
 151          {
 152   1          unsigned char a,b;
 153   1              for(;i>0;i--)
 154   1              for(b=1;b>0;b--)
 155   1                      for(a=2;a>0;a--);
 156   1      }
 157          
 158          /*********************************************************************
 159          * 函 数 名       : UartSendBytes
 160          * 函数功能               : 通过串口往外发送数据
 161          * 参数列表       : unsigned char *c,要发的数据
 162          * 函数输出       : 无
 163          *********************************************************************/
 164          
 165          void UartSendByte(u8 c) //从串口发送1字节数据
 166          {
 167   1              u8 i = 0;
 168   1              EA = 0;
 169   1      
 170   1              SBUF = c;
 171   1              while (!TI);
 172   1              TI = 0;
 173   1      
 174   1              EA = 1;
 175   1      }
 176          
 177          /*********************************************************************
 178          * 函 数 名       : Rc522Test
C51 COMPILER V9.01   MAIN                                                                  07/28/2020 12:51:37 PAGE 4   

 179          * 函数功能               : test1为运行代码，test2用于读取卡片id
 180          * 参数列表       : 无
 181          * 函数输出       : 无
 182          *********************************************************************/
 183          //运行代码,正确的卡号响一次，其他卡响三次
 184          void Rc522Test1(void)
 185          {
 186   1         while(1)
 187   1         {
 188   2                              
 189   2                 if (PcdRequest(0x52, Temp) == MI_OK)
 190   2                 {
 191   3                              if (PcdAnticoll(UID) == MI_OK)
 192   3                              {
 193   4                              //此处为判断是否为代码内有标注的卡序列号，除非这五张卡，否则不执行判断
 194   4                                      if(strcmp(UID,UI)==0||strcmp(UID,UI4)==0||strcmp(UID,UI1)==0||strcmp(UID,UI2)==0||strcmp(UID,UI5)==0)
 195   4                                      {
 196   5                                              
 197   5                                              BuzzerOnce();
 198   5                                              delay1ms(50);
 199   5                                              BuzzerOnce();
 200   5                                              count = 3;                                                //舵机转动
 201   5                                              delay1ms(1500);                 
 202   5                                              count=18;                                                  //舵机转回去
 203   5      
 204   5                                      }
 205   4                                      else
 206   4                                      {  
 207   5                                              BuzzerOnce();
 208   5                                         delay1ms(30);
 209   5                                              BuzzerOnce();
 210   5                                         delay1ms(30);
 211   5                                              BuzzerOnce() ;
 212   5                                         delay1ms(30);
 213   5                                              BuzzerOnce();
 214   5                                         delay1ms(30);
 215   5                                      }       
 216   4                              }
 217   3                 }
 218   2         }
 219   1      }
 220          //读取卡数据
 221          void Rc522Test2(void)
 222          {
 223   1         while(1)
 224   1         {
 225   2                 if (PcdRequest(0x52, Temp) == MI_OK)
 226   2                 {
 227   3                              if (PcdAnticoll(UID) == MI_OK)
 228   3                              {
 229   4                                      
 230   4                                      UartSendByte(UID[0]);           //读取卡序列号前四位
 231   4                                      UartSendByte(UID[1]);
 232   4                                      UartSendByte(UID[2]);
 233   4                                      UartSendByte(UID[3]);
 234   4                                      delay1ms(500);
 235   4                                      delay1ms(500);                                                                          
 236   4                              }
 237   3                 }
 238   2         }
 239   1      }
 240          
C51 COMPILER V9.01   MAIN                                                                  07/28/2020 12:51:37 PAGE 5   

 241          /*********************************************************************
 242          * 函 数 名       : SysInit
 243          * 函数功能               : 串口初始化为2400波特率，寻卡，读写卡数据
 244          * 参数列表       : 无
 245          * 函数输出       : 无
 246          *********************************************************************/
 247          void SysInit(void)
 248          {
 249   1          TMOD = 0x21;                // T1设置为8位自动重装载定时器                  
 250   1          SCON = 0x40;                // 串口工作在模式1：8位UART波特率可变，且禁止接收
 251   1          TH1 = 0xE8;                 // 单片机小精灵V1.3算出的2400波特率且波特率
 252   1          TL1 = TH1;                  // 加倍时的定时器设置值。
 253   1          PCON = 0x80;                // 设置为波特率加倍
 254   1              EA = 1;                         // 开总中断
 255   1              ES = 1;                     // 开串口中断
 256   1              TR1 = 1;                    // 定时器1开启计数
 257   1      
 258   1              gBuzzer = 0;
 259   1          PcdReset();                         //复位RC522
 260   1          PcdAntennaOff();            //关天线                
 261   1          PcdAntennaOn();             //开天线
 262   1              M500PcdConfigISOType('A');
 263   1      }


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    469    ----
   CONSTANT SIZE    =   ----    ----
   XDATA SIZE       =   ----    ----
   PDATA SIZE       =   ----    ----
   DATA SIZE        =     43       4
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
